<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ラングトンの蟻</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <style media="screen">
      .margin-120 {
        margin-top : 120px;
      }
    </style>
    <script type="text/javascript">

      //変数の定義
      //ステップ数のカウント
      let step;

      //フレーム数
      let frame;

      //空間の座標および（蟻がいるとき）その向き、色が白黒どちらか、の情報を格納する配列。
      let space = []
      //※ジャグ配列の詳細は以下
      //第1階層：X座標
      //第2階層：Y座標
      //第3階層：座標のプロパティ
      //  1つ目の要素：色（0…白、1…赤、2…緑、3…青）
      //　2つ目の要素：蟻の向き（0…上、1…右、2…下、3…左）

      //空間の大きさ
      let spaceSizeX;
      let spaceSizeY;

      let eachSpaceWidth;
      let eachSpaceHeight;

      //蟻の数
      let antNumber;

      //蟻の位置（の配列）
      let antPositionX = [];
      let antPositionY = [];

      //蟻のいる場所の情報
      let antPositionColor = [];
      let antDirection = [];

      //蟻の方向転換パターンの変数
      let antTurnPattern = []

      //色の数
      let colorNumber = 4;

      //タイマー
      let timer;

      //キャンバス
      let canvas;

      //キャンバスのコンテキスト
      let ctx;

      //再描画対象の座標を格納する配列
      let repaintTargetX = [];
      let repaintTargetY = [];


      //ロード後に自動起動
      onload = initialize;

      function initialize(){
        //ステップの初期化
        step = 0;

        //フレーム数の初期化;
        frame = parseInt(document.getElementById("inputFrame").value);

        //空間の大きさの初期化
        spaceSizeX = parseInt(document.getElementById("inputSpaceSizeX").value);
        spaceSizeY = parseInt(document.getElementById("inputSpaceSizeY").value);

        //バリデーションチェック
        if(frame < 0 || spaceSizeX < 0 || spaceSizeY < 0){
          alert("ステップ数または空間サイズの初期値が不正です。");
          return false;
        }

        //キャンバス・キャンバスのコンテキストの設定
        canvas = document.getElementById("canvas");
        ctx = canvas.getContext("2d");

        //キャンバスを白塗りしておく。
        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, canvas.width, canvas.height)


        //設定後はパラメータを入力不可にする
        document.getElementById("inputFrame").disabled = true;
        document.getElementById("inputSpaceSizeX").disabled = true;
        document.getElementById("inputSpaceSizeY").disabled = true;
        document.getElementById("randomLevel").disabled = true;
        document.getElementById("antNumber").disabled = true;
        document.querySelectorAll(".antPositionInputX").forEach(
          (d) => {d.disabled = true}
        );
        document.querySelectorAll(".antPositionInputY").forEach(
          (d) => {d.disabled = true}
        );
      
        document.querySelectorAll(".antTurnPattern").forEach(
          (d) => {d.disabled = true}
        );

        //停止・再開ボタンは入力可能にする。
        document.getElementById('changeTimerStatus').disabled = false;

        //乱雑レベルの読み込み
        let randomLevel = Number(document.getElementById("randomLevel").value);

        //空間の初期化

        repaintTargetX = [];
        repaintTargetY = [];

        for(let i = 0; i < spaceSizeX; i++){
          space[i] = []
          for(let j = 0; j < spaceSizeY; j++){
            //乱数を生成し、乱雑レベル以下だったら色を変える。 色の種類（4色）は適当。
            let random = Math.random() * 100;
            if(random < randomLevel){
              space[i][j] = [Math.floor(random * 100) % 4 ,0, 0];
            } else{
                space[i][j] = [0, 0, 0];
            }
            repaintTargetX.push(i);
            repaintTargetY.push(j);
          }
        }

        //蟻の位置の初期化
        antNumber = document.getElementById("antNumber").value;

        for(let i = 0; i < antNumber; i++){
          antPositionX[i] = Number(document.getElementById("antPositionInputX" + i).value) % spaceSizeX;
          antPositionY[i] = Number(document.getElementById("antPositionInputY" + i).value) % spaceSizeY;
      
          antDirection[i] = 0;
          antPositionColor[i] = 0;

          antTurnPattern[i] = document.getElementById("antTurnPattern" + i).value;

          //バリデーションチェック
          if(antPositionX[i] > spaceSizeX || antPositionX[i] < 1 || antPositionY[i] > spaceSizeX || antPositionY[i] < 1){
            alert("蟻の位置が不正です。");
            return false;
          }
        }

        //初期描画
        repaint()


        //タイマーの初期化
        timer = setInterval(tick, frame);

        return true;
      }

      //フレームごとに呼ばれる蟻の位置の再計算＆再描画の処理。
      function tick(){
        //蟻の位置の再計算

        repaintTargetX = [];
        repaintTargetY = [];
        for(let i = 0; i < antNumber; i++){
          antPositionCalculate(i);
        }

        //再描画（初期化時にも使うので関数として切り出し）
        repaint();

        //ステップ数の更新
        step++;
        document.getElementById("showStep").textContent = "step : " + step;
      }

      
      function antPositionCalculate(antIndex){
        //再描画の必要がある空間の座標を格納

        //次は右回りか左回りかの変数（今いる座標の色によって設定）
        let tempRotationAngle;

        //蟻が現在いる座標の色を反転＆色に応じて向きを変える

        switch(antTurnPattern[antIndex]){
         case "RLRL" :
          switch (space[antPositionX[antIndex]][antPositionY[antIndex]][0]) {
            case 0:
              tempRotationAngle = 1;
              break;

            case 1:
              tempRotationAngle = 3;
              break;

            case 2:
              tempRotationAngle = 1;
              break;

            case 3:
              tempRotationAngle = 3;
              break;

            default:
              alert('蟻の場所の色が不正エラー。')
          }
        break;

        case "RLLR" :
          switch (space[antPositionX[antIndex]][antPositionY[antIndex]][0]) {
            case 0:
              tempRotationAngle = 1;
              break;

            case 1:
              tempRotationAngle = 3;
              break;

            case 2:
              tempRotationAngle = 3;
              break;

            case 3:
              tempRotationAngle = 3;
              break;

            default:
              alert('蟻の場所の色が不正エラー。')
          }
        break;

        case "RRRL" :
          switch (space[antPositionX[antIndex]][antPositionY[antIndex]][0]) {
            case 0:
              tempRotationAngle = 1;
              break;

            case 1:
              tempRotationAngle = 1;
              break;

            case 2:
              tempRotationAngle = 1;
              break;

            case 3:
              tempRotationAngle = 3;
              break;

            default:
              alert('蟻の場所の色が不正エラー。')
          }
        break;

        case "RRLL" :
          switch (space[antPositionX[antIndex]][antPositionY[antIndex]][0]) {
            case 0:
              tempRotationAngle = 1;
              break;

            case 1:
              tempRotationAngle = 1;
              break;

            case 2:
              tempRotationAngle = 3;
              break;

            case 3:
              tempRotationAngle = 3;
              break;

            default:
              alert('蟻の場所の色が不正エラー。')
          }
        break;


        default:
          alert("蟻の方向転換パターンが不正エラー。");
        }
  
        //次の色に変更
        space[antPositionX[antIndex]][antPositionY[antIndex]][0] = (space[antPositionX[antIndex]][antPositionY[antIndex]][0] + 1) % colorNumber;
            
        //再描画対象に設定
        repaintTargetX.push(antPositionX[antIndex]);
        repaintTargetY.push(antPositionY[antIndex]);


        //蟻が進む向きの計算
        let nextDirection = (space[antPositionX[antIndex]][antPositionY[antIndex]][1] + tempRotationAngle) % 4;

        //蟻の向きの決定
        switch (nextDirection) {
          case 0:
            antPositionY[antIndex]--;
            break;
          case 1:
            antPositionX[antIndex]++;
            break;
          case 2:
            antPositionY[antIndex]++;
            break;
          case 3:
            antPositionX[antIndex]--;
            break;
          default:
            alert("蟻の向きの決定時にエラーが起きました。");
        }
        //領域外に行ってたら逆から出てくる（周期的境界条件）。
        antPositionY[antIndex] = (antPositionY[antIndex] + spaceSizeY) % spaceSizeY;
        antPositionX[antIndex] = (antPositionX[antIndex] + spaceSizeX) % spaceSizeX;

        //再描画対象に設定
        repaintTargetX.push(antPositionX[antIndex]);
        repaintTargetY.push(antPositionY[antIndex]);

        //蟻の向きの設定。
        space[antPositionX[antIndex]][antPositionY[antIndex]][1] = nextDirection;

        antPositionColor[antIndex] = space[antPositionX[antIndex]][antPositionY[antIndex]][0]
        antDirection[antIndex] = space[antPositionX[antIndex]][antPositionY[antIndex]][0]

        return true;
      }

      function repaint(){

        //再描画

        //各座標のサイズを取得
        eachSpaceWidth = canvas.width / spaceSizeX;
        eachSpaceHeight = canvas.height / spaceSizeY;

        //再描画する必要のある箇所だけ再描画
        for(let i = 0; i < repaintTargetX.length; i++){
          tempX = repaintTargetX[i];
          tempY = repaintTargetY[i];
          switch (space[tempX][tempY][0]) {
            //白
            case 0:
            ctx.fillStyle = "white";
            ctx.fillRect(eachSpaceWidth * tempX, eachSpaceHeight * tempY, eachSpaceWidth, eachSpaceHeight);
              break;
            //赤
            case 1:
            ctx.fillStyle = "red";
            ctx.fillRect(eachSpaceWidth * tempX, eachSpaceHeight * tempY, eachSpaceWidth, eachSpaceHeight);
            break;
            //緑
            case 2:
            ctx.fillStyle = "green";
            ctx.fillRect(eachSpaceWidth * tempX, eachSpaceHeight * tempY, eachSpaceWidth, eachSpaceHeight);
            break;
            //青
            case 3:
            ctx.fillStyle = "blue";
            ctx.fillRect(eachSpaceWidth * tempX, eachSpaceHeight * tempY, eachSpaceWidth, eachSpaceHeight);
            break;

            default:
              alert("色の描画時エラー");
          }
        }

        //蟻を描画

        ctx.fillStyle = "purple";

        for(let i = 0; i < antNumber; i++){
          ctx.fillRect(eachSpaceWidth * antPositionX[i] + eachSpaceWidth * 0.35 , eachSpaceHeight * antPositionY[i] + eachSpaceHeight * 0.35, eachSpaceWidth * 0.3, eachSpaceHeight * 0.3);
        }
        return true;

      }

      //タイマーの停止・再開ボタン用の関数
      function changeTimerStatus(){
        changeTimerText = document.getElementById('changeTimerStatus').textContent;
        switch (changeTimerText) {
          case "stop":
            document.getElementById('changeTimerStatus').textContent = "start";
            clearInterval(timer);
            break;
          case "start":
            document.getElementById('changeTimerStatus').textContent = "stop";
            timer = setInterval(tick, frame);
            break;
          default:
        }
      }

      //状態の初期化ボタン用の関数
      function resetTimerStatus(){
        resetTimerText = document.getElementById('resetTimerStatus').textContent;
        switch (resetTimerText) {
          case "reset":
            document.getElementById('resetTimerStatus').textContent = "restart";
            document.getElementById('changeTimerStatus').textContent = "stop";
            document.getElementById('changeTimerStatus').disabled = true;
            clearInterval(timer);
            document.getElementById("inputFrame").disabled = false;
            document.getElementById("inputSpaceSizeX").disabled = false;
            document.getElementById("inputSpaceSizeY").disabled = false;
            document.getElementById("randomLevel").disabled = false;
            document.getElementById("antNumber").disabled = false;
            document.querySelectorAll(".antPositionInputX").forEach(
              (d) => {d.disabled = false}
            );
            document.querySelectorAll(".antPositionInputY").forEach(
              (d) => {d.disabled = false}
            );
            document.querySelectorAll(".antTurnPattern").forEach(
              (d) => {d.disabled = false}
            );

            break;
          case "restart":
            document.getElementById('resetTimerStatus').textContent = "reset";
            clearInterval(timer);
            initialize();
            break;
          default:
        }
      }

    function setupEachAntPosition(){
      //変更されたantNumberを取得。
      let antNumber = document.getElementById("antNumber").value;

      //削除前に入力されている値を取っておく
      let tempAntPreviousInitialPositionsX = [];
      let tempAntPreviousInitialPositionsY = [];
      let tempAntPreviousTurnPattern = [];

      document.querySelectorAll(".antPositionInputX").forEach((d) => {
        tempAntPreviousInitialPositionsX.push(d.value)
      });

      document.querySelectorAll(".antPositionInputY").forEach((d) => {
        tempAntPreviousInitialPositionsY.push(d.value)
      });

      document.querySelectorAll(".antTurnPattern").forEach((d) => {
        tempAntPreviousTurnPattern.push(d.value)
      });


      //既に追加されている蟻の位置の入力を受け付けるinput要素をすべて削除する。
      let antPositionDOMs = document.querySelectorAll(".antPositionDOMs");

      antPositionDOMs.forEach((d) => {
        
        d.remove();
      });

      //input要素を追加しなおす。
      //追加先の親要素を取得。
      let antPostionDomsContainer = document.getElementById("antPostionDomsContainer");
      
      for(let i = 0; i < antNumber; i++){
        //divを追加
        tempAntPositionDiv = document.createElement("div");
        tempAntPositionDiv.value = 0;
        tempAntPositionDiv.className = "antPositionDOMs m-4 d-flex flex-column flex-md-row justify-content-around";

        //labelとinput（X）
        tempAntPositionLabelX = document.createElement("label");
        tempAntPositionLabelX.htmlFor = "antPositionInputX" + i;
        tempAntPositionLabelX.textContent = "蟻" + (i + 1) + " のX座標";
        tempAntPositionInputX = document.createElement("input");
        tempAntPositionInputX.type = "number";
        tempAntPositionInputX.className = "antPositionInputX";
        tempAntPositionInputX.id = "antPositionInputX" + i;
        tempAntPositionInputX.min = 1;
        
        //labelとinput（Y）
        tempAntPositionLabelY = document.createElement("label");
        tempAntPositionLabelY.htmlFor = "antPositionInputY" + i;
        tempAntPositionLabelY.textContent = "蟻" + (i + 1) + " のY座標"
        tempAntPositionInputY = document.createElement("input");
        tempAntPositionInputY.type = "number";
        tempAntPositionInputY.className = "antPositionInputY";
        tempAntPositionInputY.id = "antPositionInputY" + i;
        tempAntPositionInputY.min = 1;

        //蟻の方向転換パターン
        tempAntTurnPatternLabel = document.createElement("label");
        tempAntTurnPatternLabel.htmlFor = "antTurnPattern" + i;
        tempAntTurnPatternLabel.textContent = "蟻の方向転換パターン"

        tempAntTurnPatternSelect = document.createElement("select");
        tempAntTurnPatternSelect.className = "antTurnPattern";
        tempAntTurnPatternSelect.id = "antTurnPattern" + i;

        tempAntTurnPatternOption1 =  document.createElement("option");
        tempAntTurnPatternOption1.value = "RLRL";
        tempAntTurnPatternOption1.textContent = "RLRL";
        tempAntTurnPatternOption2 =  document.createElement("option");
        tempAntTurnPatternOption2.value = "RLLR";
        tempAntTurnPatternOption2.textContent = "RLLR";
        tempAntTurnPatternOption3 =  document.createElement("option");
        tempAntTurnPatternOption3.value = "RRRL";
        tempAntTurnPatternOption3.textContent = "RRRL";
        tempAntTurnPatternOption4 =  document.createElement("option");
        tempAntTurnPatternOption4.value = "RRLL";
        tempAntTurnPatternOption4.textContent = "RRLL";
        tempAntTurnPatternSelect.appendChild(tempAntTurnPatternOption1);
        tempAntTurnPatternSelect.appendChild(tempAntTurnPatternOption2);
        tempAntTurnPatternSelect.appendChild(tempAntTurnPatternOption3);
        tempAntTurnPatternSelect.appendChild(tempAntTurnPatternOption4);

        //以前の値を設定。
        if(i < tempAntPreviousInitialPositionsX.length){
          tempAntPositionInputX.value = tempAntPreviousInitialPositionsX[i];
        }
        if(i < tempAntPreviousInitialPositionsY.length){
          tempAntPositionInputY.value = tempAntPreviousInitialPositionsY[i];
        }
        if(i < tempAntPreviousTurnPattern.length){
          tempAntTurnPatternSelect.value = tempAntPreviousTurnPattern[i];
        }

        //div要素にinputとラベルを追加
        tempAntPositionDiv.appendChild(tempAntPositionLabelX);
        tempAntPositionDiv.appendChild(tempAntPositionInputX);
        tempAntPositionDiv.appendChild(tempAntPositionLabelY);
        tempAntPositionDiv.appendChild(tempAntPositionInputY);
        tempAntPositionDiv.appendChild(tempAntTurnPatternLabel);
        tempAntPositionDiv.appendChild(tempAntTurnPatternSelect);

        //div要素を親要素に追加。
        antPostionDomsContainer.appendChild(tempAntPositionDiv);
      }
    
    }

    </script>
  </head>
  <body>
    <h1 class="display-3 bg-success p-3 fixed-top">ラングトンの蟻</h1>
    <div class="container margin-120 p-3">
      <div class="row">
        <div class="col-md-6">
          <p>
            ラングトンの蟻とは、ある簡単な規則に基づいて碁盤の目状をアリがマスを塗りながら進んでいくというシミュレーションです。<br>
            詳細についてはWikipediaを参照してください。
            <br>
            <a href="https://ja.wikipedia.org/wiki/%E3%83%A9%E3%83%B3%E3%82%B0%E3%83%88%E3%83%B3%E3%81%AE%E3%82%A2%E3%83%AA"></a>
          </p>
          <p>
            ルールのシンプルさの割に複雑な動きをするのですが、一定の時間がたつとあるパターンを繰り返すようになったり、初期値によって大きく動きが変わったりと面白いです。
          </p>
          <hr>
          <p>
            本バージョンでは蟻を複数設定可能です（最大8匹まで）。
            <br>
            それぞれの蟻がマスを通過するたびに、白→赤→緑→青→白→… と色が循環します。
            <br>
            蟻が移動する際に蟻は右に90°あるいは左に90°方向転換します。 
            <br>
            蟻ごとにパターンを設定可能で、"RLRL"・"RLLR"・"RRRL", "RRLL"から選択可能です。
            <br>
            ※パターンの例："RLRL"の場合、
            <ul>
              <li>
                白色のマスを踏む→右に90°方向転換する。
              </li>
                           <li>
                赤色のマスを踏む→左に90°方向転換する。
              </li>
             <li>
                緑色のマスを踏む→右に90°方向転換する。
              </li>
              <li>
                青色のマスを踏む→左に90°方向転換する。
              </li>
            </ul>
            <br>
          空間のサイズや実行速度も調整可能です。
          <br>
          各マスの初期色は「ランダム度」を0より大きな値にすることで変化させることができます。
          </p>
          <p>
            いろいろ遊んでみてください。
          </p>
        </div>
        <div class="col-md-6">
          <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgwxvM_aIpjK3_mpD_lxiahZMC5JpvE_3V6eqHzD8ssvidrQyVKz8bkd9Mz9NuvXYgqfIhCbK45oeBQpVBgIbcVCSjafkwy6BuRS4HlGwB9ktDZ8pMHtGXEqkifdz0kTeX5Wa6ulyP8yVj5/s400/mushi_ari.png" alt="" class="img-fluid">
        </div>
      </div>
    </div>
    <p class="text-center">空間・時間の設定</p>
    <div class="container w-75">
      <div class="d-flex flex-column flex-lg-row justify-content-around">
        <div class="d-flex flex-column">
          <label for="inputSpaceSizeX">空間のX方向の長さ</label>
          <input type="number" name="" value="150" id="inputSpaceSizeX" class="" min="1">
        </div>
        <div class="d-flex flex-column">
          <label for="inputSpaceSizeY">空間のY方向の長さ</label>
          <input type="number" name="" value="75" id="inputSpaceSizeY" class="" min="1">
        </div>
        <div class="d-flex flex-column">
          <label for="inputFrame">フレームの単位（ミリ秒）</label>
          <input type="number" name="" value="4" id="inputFrame" class="" min="4">
        </div>
        <div class="d-flex flex-column">
          <label for="randomLevel">ランダム度（%）</label>
          <input type="number" name="" value="0" id="randomLevel" class="" step="0.001" min="0" max="100">
        </div>
      </div>
    </div>
    <p class="text-center m-4">蟻の初期配置の設定</p>
    <div class="container w-75">
      <div class="d-flex flex-column flex-md-row justify-content-around">
        <div class="d-flex flex-column">
          <label for="antNumber">蟻の数</label>
          <input type="number" name="" value="1" id="antNumber" class="" step="1" min="1" max="8" onchange="setupEachAntPosition()">
        </div>
      </div>
      <div class="container">
        <div class="row justify-content-around" id="antPostionDomsContainer">
          <div class="antPositionDOMs m-4 d-flex flex-column flex-md-row justify-content-around">
            <label for="antPositionInputX0">蟻1 のX座標</label><input type="number" id="antPositionInputX0" min="1" value="75" disabled="true" class="antPositionInputX">
            <label for="antPositionInputY0">蟻1 のY座標</label><input type="number" id="antPositionInputY0" min="1" value="37" disabled="true"  class="antPositionInputY">
            <label for="antPositionInputY0">蟻1 の方向転換パターン</label>
            <select id="antTurnPattern0" disabled="true"  class="antTurnPattern">
              <option value="RLRL" selected="selected">RLRL</option>
              <option value="RLLR">RLLR</option>
              <option value="RRRL">RRRL</option>
              <option value="RRLL">RRLL</option>
            </select>
          </div>
        </div>
      </div>
    </div>
    <div>
      <div class="container">
        <div class="d-flex justify-content-center">
          <p class="m-4">
            <spanid id = "showStep">step : </span>
          </p>
          <div class="">
            <button type="button" name="button" id="resetTimerStatus" class="m-4" onclick="resetTimerStatus()">reset</button>
          </div>
          <div class="">
            <button type="button" name="button" id="changeTimerStatus" class="m-4" onclick="changeTimerStatus()">stop</button>
          </div>
        </div>
      </div>
    </div>
    <div class="container-flex d-flex justify-content-center">
      <canvas id="canvas" class="border border-primary m-3 w-75 h-75"></canvas>
    </div>
    <footer class="py-3 bg-dark text-light">
       <p class="text-center">Created by Nagashima66 on 2025/12/15</p>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
  </body>
</html>
